---
title: "W4Assignment"
author: "7cats"
date: "30/07/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
```
The data is stored in file "repdata_data_StormData.csv.bz2" and read into variable metaData
```{r loading Data, cache = TRUE}
metaData <- read.csv("repdata_data_StormData.csv.bz2")
```

Transforming the original date and time
```{r processing date, cache = TRUE}
metaData <- metaData %>%
    mutate(stDatetemp = as.data.frame(t(as.data.frame(strsplit(metaData$BGN_DATE,' '))))$V1) %>%
    mutate(stDate = as.Date(stDatetemp, format = '%m/%d/%Y'), stDatetemp = NULL) %>%
    mutate(stTime = format(strptime(BGN_TIME, format="%H%M"), format = "%H:%M"), BGN_TIME = NULL)
```
Transformed start date is stored in variable stDate and start time in stTime

First events with zero property/crop damage and fatalities/injuries are removed from the table for simplicity
```{r}
metaData <- metaData %>%
    mutate(damage = PROPDMG + FATALITIES + INJURIES + CROPDMG) %>%
    .[-.$damage == 0,]
```

Analyse the relationship between event type and population health
```{r reducing classes of event type}
keyType <- paste( c("FLOOD","HEAT","COLD","WIND","ICE","STORM","RAIN","TIDE","FROST","SURF","FIRE","FOG","RIP CURRENT","SLIDE","DRY"),collapse = "|")
metaData <- metaData %>%
    mutate(EVTYPE = toupper(EVTYPE),
           EVTYPE = str_replace_all(EVTYPE,"TSTM|THUNDERSTORM|TORNADO|TYPHOON|HURRICANE|TROPICAL STORM|FUNNEL CLOUD|DRY MICROBURST","STORM"),
           EVTYPE = str_replace_all(EVTYPE,"WINDCHILL|WINTER WEATHER","COLD"),
           EVTYPE = str_replace_all(EVTYPE,"FLD","FLOOD"),
           EVTYPE = str_replace_all(EVTYPE,"AVALANCHE","SLIDE"),
           EVTYPE = str_replace_all(EVTYPE,"HAIL|WINTER STORM|SLEET|SNOW|BLIZZARD|FREEZE|FROST","ICE"),
           EVTYPE = ifelse(is.na(str_extract(EVTYPE,keyType)),EVTYPE,str_extract(EVTYPE,keyType)),
           EVTYPE = str_replace_all(EVTYPE,"SURF|TIDE|STORM SURGE","HIGH WATER LEVEL"),
    )
```
All weather phenomenons are reduced to 15 types: Flood, Heat, Cold, Wind, Ice, Storm, Rain, Tide, Frost, High Water Level, Fog, and Rip Current. The classification might be accurate but simply used as a method in this assignment. After classified, the data will be grouped and each group's relation with population damage will be analysed.

```{r}
metaData <- metaData %>%
    group_by(EVTYPE) %>%
    mean(FATALITIES)

```

