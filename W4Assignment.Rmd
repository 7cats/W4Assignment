---
title: "W4Assignment"
author: "7cats"
date: "30/07/2020"
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
```
The data is stored in file "repdata_data_StormData.csv.bz2" and read into variable metaData
```{r loading Data, cache = TRUE}
metaData <- read.csv("repdata_data_StormData.csv.bz2")
```

First events with zero property/crop damage and fatalities/injuries are removed from the table for simplicity
```{r}
metaData <- metaData %>%
    mutate(damage = PROPDMG + FATALITIES + INJURIES + CROPDMG) %>%
    .[.$damage != 0,]
```

Analyse the relationship between event type and population health
```{r reducing classes of event type,, cache = TRUE}
keyType <- paste( c("FLOOD","TEMP.","WIND","ICE","STORM","RAIN","FIRE","FOG","RIP CURRENT","SLIDE","DRY","WET","DUST","OTHER","HWL","LIGHT"),collapse = "|")
metaData <- metaData %>%
    mutate(EVTYPE = toupper(EVTYPE),
           EVTYPE = str_replace_all(EVTYPE,"WAYTERSPOUT|WATER SPOUT","WATERSPOUT"),
           EVTYPE = str_replace_all(EVTYPE,"TSTM|THUNDERSTORM|TORNADO|TYPHOON|HURRICANE|TROPICAL STORM|FUNNEL|DRY MICROBURST|FLOYD|
                                    |TROPICAL DEPRESSION|WATERSPOUT|WALL CLOUD|GUSTNADO|BURST|TURBULENCE|TORNDAO|LANDSPOUT","STORM"),
           EVTYPE = str_replace_all(EVTYPE,"WINDCHILL|WINTER WEATHER|COOL|WINTER|LOW TEMP|WINTRY|HOT|WARM|HEAT|WARTH|HYPERTHERMIA|
                                    |HIGH TEMPERATURE|TEMPERATURE|COLD|RECORD","TEMP."),
           EVTYPE = str_replace_all(EVTYPE,"FLD|URBAN|DAM|STREAM|FLOOODING","FLOOD"),
           EVTYPE = str_replace_all(EVTYPE,"DROUGHT|DRIEST","DRY"),
           EVTYPE = str_replace_all(EVTYPE,"PRECIPITATION|PRECIP|SHOWERS|SHOWER|DRIZZLE","RAIN"),
           EVTYPE = str_replace_all(EVTYPE,"AVALANCHE|SLUMP|EROSION|EROSIN|AVALANCE","SLIDE"),
           EVTYPE = str_replace_all(EVTYPE,"VOLCAN|SMOKE","DUST"),
           EVTYPE = str_replace_all(EVTYPE,"MARINE MISHAP|APACHE COUNTY|MARINE ACCIDENT|HEAVY MIX|DROWNING|[?]|HIGH","OTHER"),
           EVTYPE = str_replace_all(EVTYPE,"WND","WIND"),
           EVTYPE = str_replace_all(EVTYPE,"LIGHTING|LIGHTNING|LIGHTS|LIGNTNING","LIGHT"),
           EVTYPE = str_replace_all(EVTYPE,"HAIL|WINTER STORM|SLEET|SNOW|BLIZZARD|FREEZE|FROST|ICY|GLAZE|FREEZING","ICE"),
           EVTYPE = str_replace_all(EVTYPE,"SURF|TIDE|STORM SURGE|HIGH WAVES|HIGH WATER|COASTAL SURGE|TSUNAMI|
           |SWELLS|SEICHE|HIGH SEAS|RISING WATER|HEAVY SEAS|ROUGH SEAS|ROGUE WAVE","HWL"),
           EVTYPE = ifelse(is.na(str_extract(EVTYPE,keyType)),EVTYPE,str_extract(EVTYPE,keyType))
    )
unique(metaData$EVTYPE)
```
All weather phenomenons are reduced to 15 types: Flood, Temp., Wind, Ice, Storm, Rain, Fire, Fog, Rip Current, Slide, Dry, Wet, Dust, other, High Water Level, Light. The classification might not be accurate but it's simply used as a method in this assignment. After classified, the data will be grouped and each group's relation with population damage will be analysed.
First to calculate the economic damage the unit of damage and value should be combined. The unit of damage is recorded in variable: "PROPDMGEXP" and "CROPDMGEXP". Some rows contain abnormal unit are excluded from the dataset.
```{r}
metaData <- metaData %>%
    mutate(CROPDMGEXP = toupper(CROPDMGEXP)) %>%
    mutate(PROPDMGEXP = toupper(PROPDMGEXP)) %>%
    filter(grepl(paste( c("K","B","H","M"), collapse = "|"), CROPDMGEXP)) %>%
    filter(grepl(paste( c("K","B","H","M"), collapse = "|"), PROPDMGEXP)) %>%
    mutate(unitCrop = sapply(CROPDMGEXP, function(x) 
        switch(grep(x,c("H","K","M","B")), 100, 1000, 1e+06, 1e+09)),
           unitProp = sapply(PROPDMGEXP, function(x)
        switch(grep(x,c("H","K","M","B")), 100, 1000, 1e+06, 1e+09))) %>%
    mutate(CROPDMG = CROPDMG*unitCrop, PROPDMG = PROPDMG*unitProp)

```

The damage to population health is measured with fatalities and injuries separately and the economic consequences are computed by crop damage and property damage. First both categories and summed.
```{r data summarization}
sumData <- metaData %>%
    group_by(EVTYPE) %>%
    summarise(
        healDamg = sum(FATALITIES, na.rm = T) + sum(INJURIES, na.rm = T),
        econDamg = sum(CROPDMG, na.rm = T) +sum(PROPDMG, na.rm = T)
        )
sumData <- sumData %>%
    gather(key = "damageType", value = "damage", healDamg:econDamg)
    
```

```{r Data }

damgLabel <- c("Economic Damage", "Health Damage")
names(damgLabel) <- c("econDamg", "healDamg")
png(file = "DamageComparison.png", bg = "transparent",width = 960, height = 480)
g <- ggplot(sumData, aes(x = EVTYPE, y = damage))
g + facet_grid(rows = vars(damageType), scales="free",
               labeller = labeller(damageType = damgLabel)) + 
    geom_bar(stat="identity", fill = "light blue") 
dev.off()
```


tinytex:::is_tinytex()